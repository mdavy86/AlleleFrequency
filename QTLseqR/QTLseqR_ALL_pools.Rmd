---
title: "qtlseqr"
author: "Casey Flay"
date: "12/08/2021"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
library(knitr)
library(RLinuxModules)
library(data.table)
library(glue) 
library(tidyverse)
library(here)
library(QTLseqr)
setDTthreads(1)
module("load openlava asub/2.2 bwa/0.7.12 samtools/1.9 bcftools/1.10.2 perlbrew/0.76")
knitr::opts_chunk$set(echo = FALSE, include=FALSE, warning = TRUE)
```

```{r transform filenames to sample, lane and suffix for data.table from symlink}
mpool  <- as.data.table(grep(paste("_samplepoolSNPs_dt.csv"), list.files(path="."), invert=FALSE, value=TRUE))
mpool  <- mpool[, V2 := str_replace_all(V1, "_samplepoolSNPs_dt.csv", "&samplepoolSNPs_dt.csv")
              ][, V2 := str_replace_all(V2, ".csv" , "&.csv")
              ][, c("V2", "V3", "V4") := tstrsplit(V2, "&", fixed=TRUE)
              ][V2!="Russell",]
#mpool2  <- mpool[, V2 := str_replace_all(V1, "_malepoolSNPS_dt.csv", "&malepoolSNPS_dt.csv")
#              ][, V2 := str_replace_all(V2, ".csv" , "&.csv")
#              ][, c("V2", "V3", "V4") := tstrsplit(V2, "&", fixed=TRUE)]
#mpool <- rbind(mpool, mpool2)
#rm(mpool1, mpool2)
```

##code to make these files is in qtlseqr_files.Rmd 
```{r group samples against parent pools and rename for QTLseqR and assign columns for QTLseqR}
obj_names <- mpool[,V2]
my_files  <- mpool[,V1]

#70gb run below, only run when reduction filters are inplace
for(i in seq(along=my_files)) {
  assign(obj_names[i], fread(my_files[i]))
}

#F12G13 <- fread('F12G13_malepool_compare.csv')#test
#F12E11 <- fread('F12H14_malepool_compare.csv')#test
#obj_names <- as.data.table(c("F12G13", "F12E11"))#test
#obj_names <- obj_names[,V1]

#relabel samples for qtlseqR
samplesold <- c('s1CHROM','s1POS','s1REF','s1ALT','r1AD0','r1AD1','r1DP','r1GQ','r1PL','r1SNPi','s1AD0','s1AD1','s1DP','s1GQ','s1PL','s1SNPi','REF_FRQ','deltaSNP')
samplesnew <-c('CHROM','POS','REF','ALT','AD_REF.LOW','AD_ALT.LOW','DP.LOW','GQ.LOW','PL.LOW','SNPindex.LOW','AD_REF.HIGH','AD_ALT.HIGH','DP.HIGH','GQ.HIGH','PL.HIGH','SNPindex.HIGH','REF_FRQ','deltaSNP')

#Main paradigm is using assign() to write an object, then you need to retrieve it without using quotes. The other issue is naming all the objects, and using some kind of alphanumeric coding convention
for(i in seq(along=obj_names)) {
  dt_name <- get(obj_names[i], envir = .GlobalEnv)
  assign(obj_names[i], setnames(dt_name, glue("{samplesold}"), glue("{samplesnew}")))
}
```

```{r clean columns and change to chr01 for ggplot to assemble in the right order}

for(i in seq(along=obj_names)) {
  dt_name <- get(obj_names[i], envir = .GlobalEnv)
  assign(obj_names[i], dt_name[, `:=` ('p1CHROM'=NULL, 'p1POS'=NULL, 'p1REF'=NULL, 'p1ALT'=NULL, 'p1AD0'=NULL, 'p1AD1'=NULL, 'p1DP'=NULL, 'p1GQ'=NULL, 'p1PL'=NULL, 'V19'=NULL)])
}

#Russell <- Russell[, `:=` ('p1CHROM'=NULL,'p1POS'=NULL,'p1REF'=NULL,'p1ALT'=NULL,'p1AD0'=NULL,'p1AD1'=NULL,'p1DP'=NULL,'p1GQ'=NULL,'p1PL'=NULL,'V19'=NULL)]

for(i in seq(along=obj_names)) {
  assign(obj_names[i], get(obj_names[i], envir = .GlobalEnv)[, "CHROM" := as.factor(CHROM)])
}
#sapply(F12G13, class)

chrs <- c("chr1", "chr2", "chr3",  "chr4",  "chr5",  "chr6",  "chr7",  "chr8",  "chr9", "chr10", "chr11", "chr12", "chr13", "chr14", "chr15", "chr16", "chr17", "chr18", "chr19",  "chr20", "chr21", "chr22", "chr23", "chr24", "chr25", "chr26", "chr27", "chr28", "chr29")

for(i in seq(along=obj_names)) {
  dt_name <- get(obj_names[i], envir = .GlobalEnv)
  assign(obj_names[i], dt_name[, CHROM := fct_relevel(dt_name[,CHROM], chrs, after = Inf)])
}
#ck0201<-setnames(ck0201, glue("{samplesold}"),glue("{samplesnew}"))
```

```{r filter, eval=TRUE}
CK02_01 <- filterSNPs(SNPset = CK02_01, refAlleleFreq = 0.05, minTotalDepth = 40, maxTotalDepth = 85, depthDifference = 50, minSampleDepth = 10, minGQ = 100, verbose = TRUE)
CK10_02 <- filterSNPs(SNPset = CK10_02, refAlleleFreq = 0.05, minTotalDepth = 40, maxTotalDepth = 130, depthDifference = 50, minSampleDepth = 10, minGQ = 100, verbose = TRUE)
CK19_03 <- filterSNPs(SNPset = CK19_03, refAlleleFreq = 0.05, minTotalDepth = 35, maxTotalDepth = 85, depthDifference = 50, minSampleDepth = 10, minGQ = 100, verbose = TRUE)
CK20_01 <- filterSNPs(SNPset = CK20_01, refAlleleFreq = 0.05, minTotalDepth = 40, maxTotalDepth = 90, depthDifference = 50, minSampleDepth = 10, minGQ = 100, verbose = TRUE)
CK22_03 <- filterSNPs(SNPset = CK22_03, refAlleleFreq = 0.05, minTotalDepth = 60, maxTotalDepth = 170, depthDifference = 50, minSampleDepth = 10, minGQ = 100, verbose = TRUE)
CK23_08 <- filterSNPs(SNPset = CK23_08, refAlleleFreq = 0.05, minTotalDepth = 20, maxTotalDepth = 85, depthDifference = 50, minSampleDepth = 10, minGQ = 100, verbose = TRUE)
CK51_01 <- filterSNPs(SNPset = CK51_01, refAlleleFreq = 0.05, minTotalDepth = 30, maxTotalDepth = 100, depthDifference = 50, minSampleDepth = 10, minGQ = 100, verbose = TRUE)
CK51_09 <- filterSNPs(SNPset = CK51_09, refAlleleFreq = 0.05, minTotalDepth = 40, maxTotalDepth = 150, depthDifference = 50, minSampleDepth = 10, minGQ = 100, verbose = TRUE)
#Russell <- filterSNPs(SNPset = Russell, refAlleleFreq = 0.05, minTotalDepth = 10, maxTotalDepth = 90, depthDifference = 50, minSampleDepth = 10, minGQ = 50, verbose = TRUE)
#a_df <- filterSNPs(SNPset = a_df, refAlleleFreq = 0.05, minTotalDepth = 60, maxTotalDepth = 120, depthDifference = 50, minSampleDepth = 10, minGQ = 100, verbose = TRUE)
#b_df <- filterSNPs(SNPset = b_df, refAlleleFreq = 0.05, minTotalDepth = 50, maxTotalDepth = 120, depthDifference = 50, minSampleDepth = 10, minGQ = 100, verbose = TRUE)
#c_df <- filterSNPs(SNPset = c_df, refAlleleFreq = 0.05, minTotalDepth = 50, maxTotalDepth = 110, depthDifference = 50, minSampleDepth = 10, minGQ = 100, verbose = TRUE)
#d_df <- filterSNPs(SNPset = d_df, refAlleleFreq = 0.05, minTotalDepth = 60, maxTotalDepth = 140, depthDifference = 50, minSampleDepth = 10, minGQ = 100, verbose = TRUE)
#e_df <- filterSNPs(SNPset = e_df, refAlleleFreq = 0.05, minTotalDepth = 50, maxTotalDepth = 110, depthDifference = 50, minSampleDepth = 10, minGQ = 100, verbose = TRUE)
#f_df <- filterSNPs(SNPset = f_df, refAlleleFreq = 0.05, minTotalDepth = 60, maxTotalDepth = 130, depthDifference = 50, minSampleDepth = 10, minGQ = 100, verbose = TRUE)
#g_df <- filterSNPs(SNPset = g_df, refAlleleFreq = 0.05, minTotalDepth = 50, maxTotalDepth = 110, depthDifference = 50, minSampleDepth = 10, minGQ = 100, verbose = TRUE)
#h_df <- filterSNPs(SNPset = h_df, refAlleleFreq = 0.05, minTotalDepth = 20, maxTotalDepth = 90, depthDifference = 50, minSampleDepth = 10, minGQ = 100, verbose = TRUE)
#i_df <- filterSNPs(SNPset = i_df, refAlleleFreq = 0.05, minTotalDepth = 60, maxTotalDepth = 140, depthDifference = 50, minSampleDepth = 10, minGQ = 100, verbose = TRUE)
#j_df <- filterSNPs(SNPset = j_df, refAlleleFreq = 0.05, minTotalDepth = 40, maxTotalDepth = 100, depthDifference = 50, minSampleDepth = 10, minGQ = 100, verbose = TRUE)
```

```{r depth plot, include=TRUE, fig.show="hold", fig.width=3, fig.height=3, eval=FALSE}
for(i in seq(along=obj_names)) {
  dt_name <- get(obj_names[i], envir = .GlobalEnv)
  print(ggplot(data = dt_name) +geom_histogram(aes(x = DP.HIGH + DP.LOW)))+ggtitle(obj_names[i])+ylim(0,120000)
}
#ggplot(data = a_df) +geom_histogram(aes(x = DP.HIGH + DP.LOW)) +ggtitle("a90%m")+ylim(0,120000)
```

```{r ref frequency, include=TRUE, fig.show="hold", fig.width= 3, fig.height=3, eval=FALSE}
for(i in seq(along=obj_names)) {
  dt_name <- get(obj_names[i], envir = .GlobalEnv)
  print(ggplot(data = dt_name) +geom_histogram(aes(x = REF_FRQ))+ggtitle(obj_names[i]))
}
#ggplot(data = j_df) +geom_histogram(aes(x = REF_FRQ))+ggtitle("j11%m")
```

```{r QTLseqAnalysis}
CK02_01 <- runQTLseqAnalysis(CK02_01,windowSize=1e6, popStruc="F1", bulkSize=c(5,38), replications=10000, intervals=c(95,99))
CK10_02 <- runQTLseqAnalysis(CK10_02,windowSize=1e6, popStruc="F1", bulkSize=c(4,44), replications=10000, intervals=c(95,99))
CK19_03 <- runQTLseqAnalysis(CK19_03,windowSize=1e6, popStruc="F1", bulkSize=c(5,38), replications=10000, intervals=c(95,99))
CK20_01 <- runQTLseqAnalysis(CK20_01,windowSize=1e6, popStruc="F1", bulkSize=c(3,18), replications=10000, intervals=c(95,99))
CK22_03 <- runQTLseqAnalysis(CK22_03,windowSize=1e6, popStruc="F1", bulkSize=c(2,34), replications=10000, intervals=c(95,99))
CK23_08 <- runQTLseqAnalysis(CK23_08,windowSize=1e6, popStruc="F1", bulkSize=c(1,37), replications=10000, intervals=c(95,99))
CK51_01 <- runQTLseqAnalysis(CK51_01,windowSize=1e6, popStruc="F1", bulkSize=c(3,63), replications=10000, intervals=c(95,99))
CK51_09 <- runQTLseqAnalysis(CK51_09,windowSize=1e6, popStruc="F1", bulkSize=c(3,37), replications=10000, intervals=c(95,99))
#Russell_qtl <- runQTLseqAnalysis(Russell,windowSize = 3e6, popStruc = "F1", bulkSize = c(3,50), replications = 10000, intervals = c(95, 99))
#a_df_qtl <- runQTLseqAnalysis(a_df,windowSize = 3e6, popStruc = "F1", bulkSize = c(10,10), replications = 10000, intervals = c(95, 99))
#b_df_qtl <- runQTLseqAnalysis(b_df,windowSize = 3e6, popStruc = "F1", bulkSize = c(10,10), replications = 10000, intervals = c(95, 99))
#c_df_qtl <- runQTLseqAnalysis(c_df,windowSize = 3e6, popStruc = "F1", bulkSize = c(10,10), replications = 10000, intervals = c(95, 99))
#d_df_qtl <- runQTLseqAnalysis(d_df,windowSize = 3e6, popStruc = "F1", bulkSize = c(10,10), replications = 10000, intervals = c(95, 99))
#e_df_qtl <- runQTLseqAnalysis(e_df,windowSize = 3e6, popStruc = "F1", bulkSize = c(10,10), replications = 10000, intervals = c(95, 99))
#f_df_qtl <- runQTLseqAnalysis(f_df,windowSize = 3e6, popStruc = "F1", bulkSize = c(10,10), replications = 10000, intervals = c(95, 99))
#g_df_qtl <- runQTLseqAnalysis(g_df,windowSize = 3e6, popStruc = "F1", bulkSize = c(10,10), replications = 10000, intervals = c(95, 99))
#h_df_qtl <- runQTLseqAnalysis(h_df,windowSize = 3e6, popStruc = "F1", bulkSize = c(10,10), replications = 10000, intervals = c(95, 99))
#i_df_qtl <- runQTLseqAnalysis(i_df,windowSize = 3e6, popStruc = "F1", bulkSize = c(10,10), replications = 10000, intervals = c(95, 99))
#j_df_qtl <- runQTLseqAnalysis(j_df,windowSize = 3e6, popStruc = "F1", bulkSize = c(10,10), replications = 10000, intervals = c(95, 99))
```

```{r GprimeAnalysis}
for(i in seq(along=obj_names)) {
  dt_name <- get(obj_names[i], envir = .GlobalEnv)
  assign(obj_names[i], runGprimeAnalysis(dt_name, windowSize = 1e6, outlierFilter = "deltaSNP", filterThreshold = 0.4))
}
#ck0201_qtl <- runGprimeAnalysis(ck0201_qtl, windowSize = 2e6, outlierFilter = "deltaSNP", filterThreshold = 0.4)
```

```{r plotGprimeDist, eval=FALSE, fig.show="hold", fig.width= 5, fig.height=3}
for(i in seq(along=obj_names)) {
  dt_name <- get(obj_names[i], envir = .GlobalEnv)
  print(plotGprimeDist(SNPset = dt_name, outlierFilter = "Hampel")+ggtitle(obj_names[i]))
}
#plotGprimeDist(SNPset = ck0201_qtl, outlierFilter = "Hampel")+ggtitle("ck02_01")
```

```{r plotGprimeDist deltaSNP outlier, eval=FALSE, fig.show="hold", fig.width= 5, fig.height=3}
for(i in seq(along=obj_names)) {
  dt_name <- get(obj_names[i], envir = .GlobalEnv)
  print(plotGprimeDist(SNPset = dt_name, outlierFilter = "deltaSNP", filterThreshold = 0.4) +ggtitle(obj_names[i]))
}
#plotGprimeDist(SNPset = ck0201_qtl, outlierFilter = "deltaSNP", filterThreshold = 0.4) +ggtitle("ck02_01")
```

```{r plot QTLstats nSNPs, eval=FALSE, include=TRUE, fig.width= 20}
for(i in seq(along=obj_names)) {
  dt_name <- get(obj_names[i], envir = .GlobalEnv)
  print(plotQTLStats(SNPset = dt_name, var = "nSNPs") +ggtitle(obj_names[i]))+ylim(0,25000)
}

#plotQTLStats(SNPset = j_df_qtl, var = "nSNPs")+ggtitle("j11%m")+ylim(0,25000)
```

```{r plot QTLstats deltaSNP, eval=FALSE, include=TRUE, fig.width=20}
for(i in seq(along=obj_names)) {
  dt_name <- get(obj_names[i], envir = .GlobalEnv)
  print(plotQTLStats(SNPset = dt_name, var = "deltaSNP", plotIntervals = TRUE) +ggtitle(obj_names[i]))
}
#plotQTLStats(SNPset = ck0201_qtl, var = "deltaSNP", plotIntervals = TRUE)+ggtitle("CK02_01")
```

```{r males plotQTLstats Gprime, eval=FALSE, warnings=TRUE, include=TRUE, fig.show="hold", fig.width=20}
#trying var= "negLog10Pval" instead of "Gprime"
for(i in seq(along=obj_names)) {
  dt_name <- get(obj_names[i], envir = .GlobalEnv)
  print(plotQTLStats(SNPset = dt_name, var = "negLog10Pval", plotThreshold = TRUE, q = 0.01) + labs(title = obj_names[i]) + theme(plot.title = element_text(size = 18, hjust = 0.5)))
ggsave(paste0(obj_names[i],"_plotgp.png"), plot = last_plot(), width = 35, height = 12, units = c("cm"), dpi = 320)
}

#ck0201_plotgp <- plotQTLStats(SNPset = ck0201_qtl, var = "negLog10Pval", plotThreshold = TRUE, q = 0.01)
#ck0201_plotgp <- ck0201_plotgp + labs(title = "CK02_01") + theme(plot.title = element_text(size = 18, hjust = 0.5))
```

```{r Gprime ggplot qtls, eval=TRUE, warnings=FALSE, include=TRUE, fig.show="hold", fig.width= 20}
for(i in seq(along=obj_names)) {
dt_name   <- as.data.table(get(obj_names[i], envir = .GlobalEnv))

dt_name   <- assign(obj_names[i], dt_name[,"POSmb" := POS/1000000])
quant     <- as.numeric(quantile(dt_name[,Gprime], probs = 0.99, na.rm=T))#probs0.99 gives top 0.01% of SNPs
dt_name   <- assign(obj_names[i], dt_name[Gprime>quant, "top":="Top 1 % SNPs"][Gprime<quant, top:="Remaining SNPs"])
thresholdnumber <- min(dt_name[qvalue<0.05, Gprime])
thresholdnumber[is.finite(thresholdnumber)] <- round(thresholdnumber, digits = 3)
thresholdnumber[!is.finite(thresholdnumber)] <- 0
Threshold <- data.frame(Threshold = factor(thresholdnumber) )

if  (thresholdnumber==0){
    #if there is a significant threshold to plot apply hline threshold to graph
p <- ggplot(data=dt_name, aes(x=POSmb, y=Gprime))+
  labs(title = obj_names[i]) +
  geom_point(aes(color=factor(dt_name[,top])),size=0.01, na.rm=T)+
  scale_color_manual(name="Top SNPs",breaks = c("Top 1 % SNPs","Remaining SNPs"),values=c("chartreuse3","black"))+
  scale_x_continuous(limits=c(0, 25), breaks=c(5, 15))+
        theme(plot.title =element_text(color = "grey20", size = 10, angle = 0, hjust = .5, vjust = 0, face = "plain"),
        legend.text=element_text(color = "grey20", size = 7, angle = 0, hjust = 0, vjust = .5, face = "plain"),
        legend.title =element_text(color = "grey20", size = 8, angle = 0, hjust = 0, vjust = 0, face = "plain"),
        axis.text.x = element_text(color = "grey20", size = 7, angle = 0, hjust = .5, vjust = 0, face = "plain"),
        axis.text.y = element_text(color = "grey20", size = 7, angle = 0, hjust = 0, vjust = 0, face = "plain"),  
        axis.title.x = element_text(color = "grey20", size = 8, angle = 0, hjust = .5, vjust = 0, face = "plain"),
        axis.title.y = element_text(color = "grey20", size = 8, angle = 0, hjust = 0, vjust = .5, face = "plain"))+
  xlab("Nucleotide Position")+  
  ylab("Gprime")+
  facet_wrap(~CHROM, nrow=3, ncol=10)
  #print(p)

} else {
  #else apply graph with no threshold line
  p <- ggplot(data=dt_name, aes(x=POSmb, y=Gprime))+
  labs(title = obj_names[i]) +
  geom_point(aes(color=factor(dt_name[,top])),size=0.01, na.rm=T)+
  scale_color_manual(name="Top SNPs",breaks = c("Top 1 % SNPs","Remaining SNPs"),values=c("chartreuse3","black"))+
  scale_x_continuous(limits=c(0, 20), breaks=c(5, 15))+
      theme(plot.title =element_text(color = "grey20", size = 10, angle = 0, hjust = .5, vjust = 0, face = "plain"),
        legend.text=element_text(color = "grey20", size = 7, angle = 0, hjust = 0, vjust = .5, face = "plain"),
        legend.title =element_text(color = "grey20", size = 8, angle = 0, hjust = 0, vjust = 0, face = "plain"),
        axis.text.x = element_text(color = "grey20", size = 7, angle = 0, hjust = .5, vjust = 0, face = "plain"),
        axis.text.y = element_text(color = "grey20", size = 7, angle = 0, hjust = 0, vjust = 0, face = "plain"),  
        axis.title.x = element_text(color = "grey20", size = 8, angle = 0, hjust = .5, vjust = 0, face = "plain"),
        axis.title.y = element_text(color = "grey20", size = 8, angle = 0, hjust = 0, vjust = .5, face = "plain"))+
  xlab("Nucleotide Position")+  
  ylab("Gprime")+
    geom_hline(aes(yintercept=thresholdnumber, linetype = Threshold ), Threshold)+
    scale_linetype_manual(name = "Threshold (q=.05)", values = "dashed", labels = Threshold) +
  facet_wrap(~CHROM, nrow=3, ncol=10)
  #print(p)
}

ggsave(paste0(obj_names[i],"_Gprime_plotgp.png"), plot = last_plot(), width = 20, height = 12, units = c("cm"), dpi = 320)
}
```

```{r write top 1percent snps and sig snps so seperate plots can be made of each, eval=TRUE}
for(i in seq(along=obj_names)) {
dt_name <- as.data.table(get(obj_names[i], envir = .GlobalEnv))
dt_name   <- dt_name[,"parent" := obj_names[i]]
dt_name <- dt_name[, `:=` ("AD_REF.HIGH"=NULL, "AD_ALT.HIGH"=NULL, "DP.HIGH"=NULL, "GQ.HIGH"=NULL, "PL.HIGH"=NULL, "Cpos"=NULL,  "r1CHROM"=NULL,   "r1POS"=NULL, "r1REF"=NULL, "r1ALT"=NULL, "AD_REF.LOW"=NULL, "AD_ALT.LOW"=NULL, "DP.LOW"=NULL,  "GQ.LOW"=NULL, "PL.LOW"=NULL, "SNPindex.HIGH"=NULL, "SNPindex.LOW"=NULL, "REF_FRQ"=NULL, "deltaSNP"=NULL, "nSNPs"=NULL, "tricubeDeltaSNP"=NULL, "minDP"=NULL, "tricubeDP"=NULL, "CI_95"=NULL, "CI_99"=NULL, "G"=NULL)]

dt_name   <- dt_name[qvalue>0.05, "sig" := "nonsignificant"][qvalue<0.05, sig := "significant"]

dt_name   <- dt_name[top=="Top 1 % SNPs" | sig=="significant",] #filter just top and significant
fwrite(dt_name, file="top1percandsig_CK_snps.csv", append=T) #rename this chunk for A,BC,DE,FGHI runs
}
```



```{r read threshold snps}
threshold_snps <- fread("top1percandsig_CK_snps.csv")
```
